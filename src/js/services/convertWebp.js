// vite-plugin-convert-to-webp.js
import fs from "fs"; // –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è 'fs' –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π
import { readdirSync, statSync } from "fs"; // –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π 'readdirSync' –∏ 'statSync' –¥–ª—è —á—Ç–µ–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–∞—Ö
import { join, extname, dirname, basename } from "path"; // –ò–º–ø–æ—Ä—Ç —É—Ç–∏–ª–∏—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—É—Ç—è–º–∏ –∏–∑ –º–æ–¥—É–ª—è 'path'
import sharp from "sharp"; // –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è 'sharp' –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

function convertWebp(options = {}) { // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –ø—Ä–∏–Ω–∏–º–∞—é—â–∞—è –æ–±—ä–µ–∫—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫
    const inputDir = options.inputDir || "dist"; // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ö–æ–¥–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'dist'
    const excludeFolders = options.excludeFolder || ["images"]; // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–ø–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç—å, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ['images']
    const excludeFilesPrefix = options.excludeFilesPrefix || [ // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç—å
        "android-chrome", // –ò—Å–∫–ª—é—á–∏—Ç—å —Ñ–∞–π–ª—ã, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å 'android-chrome'
        "apple-touch-icon", // –ò—Å–∫–ª—é—á–∏—Ç—å —Ñ–∞–π–ª—ã, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å 'apple-touch-icon'
        "favicon-", // –ò—Å–∫–ª—é—á–∏—Ç—å —Ñ–∞–π–ª—ã, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å 'favicon-'
        "yandex-browser", // –ò—Å–∫–ª—é—á–∏—Ç—å —Ñ–∞–π–ª—ã, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å 'yandex-browser'
    ];
    const quality = options.quality || 80; // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ webp, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 80
    const width = options.width || null; // –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é null (–±–µ–∑ —Ä–µ—Å–∞–π–∑–∞)

    let totalOriginalBytes = 0; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—É–º–º—ã –±–∞–π—Ç–æ–≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    let totalNewBytes = 0; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—É–º–º—ã –±–∞–π—Ç–æ–≤ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

    function isExcluded(filePath) { // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω—É–∂–Ω–æ –ª–∏ –∏—Å–∫–ª—é—á–∏—Ç—å —Ñ–∞–π–ª
        if (
            excludeFolders.some((folder) =>
                filePath.startsWith(join(inputDir, folder)), // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ –ø—É—Ç—å —Ñ–∞–π–ª–∞ —Å –∏—Å–∫–ª—é—á—ë–Ω–Ω–æ–π –ø–∞–ø–∫–∏
            )
        )
            return true; // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç true, –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∏—Å–∫–ª—é—á—ë–Ω–Ω–æ–π –ø–∞–ø–∫–µ

        const name = basename(filePath); // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        if (excludeFilesPrefix.some((prefix) => name.startsWith(prefix))) // –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ –∏–º—è —Ñ–∞–π–ª–∞ —Å –∏—Å–∫–ª—é—á—ë–Ω–Ω–æ–≥–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞
            return true; // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç true, –µ—Å–ª–∏ –∏–º—è —Ñ–∞–π–ª–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏—Å–∫–ª—é—á—ë–Ω–Ω–æ–º—É –ø—Ä–µ—Ñ–∏–∫—Å—É

        return false; // –ò–Ω–∞—á–µ —Ñ–∞–π–ª –Ω–µ –∏—Å–∫–ª—é—á–∞–µ—Ç—Å—è
    }

    async function convertFile(filePath) { // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        const ext = extname(filePath).toLowerCase(); // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ
        if (![".jpg", ".jpeg", ".png"].includes(ext)) return; // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å, –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ jpg, jpeg –∏–ª–∏ png
        if (isExcluded(filePath)) return; // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å, –µ—Å–ª–∏ —Ñ–∞–π–ª –∏—Å–∫–ª—é—á—ë–Ω

        const outputPath = join( // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É—Ç–∏ –¥–ª—è —Ñ–∞–π–ª–∞ .webp
            dirname(filePath), // –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
            basename(filePath, ext) + ".webp", // –ò–º—è —Ñ–∞–π–ª–∞ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .webp
        );

        try {
            const originalSize = statSync(filePath).size; // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
            let pipeline = sharp(filePath); // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω–≤–µ–π–µ—Ä–∞ sharp –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞
            if (width) // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ —à–∏—Ä–∏–Ω–∞
                pipeline = pipeline.resize({ width, withoutEnlargement: true }); // –†–µ—Å–∞–π–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π —à–∏—Ä–∏–Ω—ã –±–µ–∑ —É–≤–µ–ª–∏—á–µ–Ω–∏—è

            const data = await pipeline // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç webp —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –∫–∞—á–µ—Å—Ç–≤–æ–º
                .toFormat("webp", { quality }) // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ webp —Å –∑–∞–¥–∞–Ω–Ω—ã–º –∫–∞—á–µ—Å—Ç–≤–æ–º
                .toBuffer(); // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ –≤–∏–¥–µ –±—É—Ñ–µ—Ä–∞
            await fs.promises.writeFile(outputPath, data); // –ó–∞–ø–∏—Å—å webp –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –≤—ã—Ö–æ–¥–Ω–æ–π –ø—É—Ç—å
            await fs.promises.unlink(filePath); // –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞

            const newSize = data.length; // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ webp —Ñ–∞–π–ª–∞

            totalOriginalBytes += originalSize; // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∫ —Å—É–º–º–µ
            totalNewBytes += newSize; // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ –∫ —Å—É–º–º–µ

            const savedPercent = ( // –†–∞—Å—á—ë—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —Å—ç–∫–æ–Ω–æ–º–ª–µ–Ω–Ω—ã—Ö –±–∞–π—Ç–æ–≤
                ((originalSize - newSize) / originalSize) *
                100
            ).toFixed(1); // –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ –æ–¥–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π

            console.log( // –õ–æ–≥ —É—Å–ø–µ—à–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ä–∞–∑–º–µ—Ä–µ
                `‚úî converted: ${filePath} ‚Üí ${outputPath} | ${(
                    originalSize /
                    1024 /
                    1024
                ).toFixed(
                    2,
                )} MB ‚Üí ${(newSize / 1024 / 1024).toFixed(2)} MB | saved ${savedPercent}%`,
            );
        } catch (err) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
            console.warn(`‚úñ skip: ${filePath} (${err.message})`); // –õ–æ–≥ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è —Å —Ç–µ–∫—Å—Ç–æ–º –æ—à–∏–±–∫–∏
        }
    }

    async function walkDir(dir) { // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ –æ–±—Ö–æ–¥–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
        const files = readdirSync(dir); // –ß—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –∏ –ø–∞–ø–æ–∫ –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        for (const file of files) { // –ü–µ—Ä–µ–±–æ—Ä –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ –∏–ª–∏ –ø–∞–ø–∫–∏
            const filePath = join(dir, file); // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –ø—É—Ç–∏ —Ñ–∞–π–ª–∞ –∏–ª–∏ –ø–∞–ø–∫–∏
            const stats = statSync(filePath); // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ –∏–ª–∏ –ø–∞–ø–∫–µ
            if (stats.isDirectory()) await walkDir(filePath); // –ï—Å–ª–∏ —ç—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–µ–∫—É—Ä—Å–∏—é
            else await convertFile(filePath); // –ò–Ω–∞—á–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª
        }
    }

    function updateHtmlUrls(dir) { // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—É—Ç–µ–π –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –≤ HTML
        const files = readdirSync(dir); // –ß—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –∏ –ø–∞–ø–æ–∫ –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        for (const file of files) { // –ü–µ—Ä–µ–±–æ—Ä –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ –∏–ª–∏ –ø–∞–ø–∫–∏
            const filePath = join(dir, file); // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –ø—É—Ç–∏ —Ñ–∞–π–ª–∞ –∏–ª–∏ –ø–∞–ø–∫–∏
            const stats = statSync(filePath); // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ –∏–ª–∏ –ø–∞–ø–∫–µ
            if (stats.isDirectory()) updateHtmlUrls(filePath); // –ï—Å–ª–∏ —ç—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–µ–∫—É—Ä—Å–∏—é
            else if (extname(filePath) === ".html") { // –ï—Å–ª–∏ —Ñ–∞–π–ª —è–≤–ª—è–µ—Ç—Å—è HTML
                let html = fs.readFileSync(filePath, "utf-8"); // –ß—Ç–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ HTML —Ñ–∞–π–ª–∞
                html = html.replace(/(\.jpg|\.jpeg|\.png)/gi, ".webp"); // –ó–∞–º–µ–Ω–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–∞ .webp
                fs.writeFileSync(filePath, html, "utf-8"); // –ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–≥–æ HTML –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ñ–∞–π–ª
                console.log(`‚úî updated HTML: ${filePath}`); // –õ–æ–≥ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è HTML
            }
        }
    }

    return { // –í–æ–∑–≤—Ä–∞—Ç –æ–±—ä–µ–∫—Ç–∞, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—â–µ–≥–æ –ø–ª–∞–≥–∏–Ω
        name: "vite-plugin-convert-to-webp", // –ò–º—è –ø–ª–∞–≥–∏–Ω–∞
        async closeBundle() { // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ö—É–∫, –≤—ã–∑—ã–≤–∞–µ–º—ã–π –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏
            await walkDir(inputDir); // –û–±—Ö–æ–¥ –≤—Ö–æ–¥–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            updateHtmlUrls(inputDir); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ HTML —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è .webp

            const savedPercent = ( // –†–∞—Å—á—ë—Ç –æ–±—â–µ–≥–æ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —Å—ç–∫–æ–Ω–æ–º–ª–µ–Ω–Ω–æ–≥–æ –≤–µ—Å–∞
                ((totalOriginalBytes - totalNewBytes) / totalOriginalBytes) *
                100
            ).toFixed(1); // –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ –æ–¥–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
            console.log( // –õ–æ–≥ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —ç–∫–æ–Ω–æ–º–∏–∏
                `\nüíæ Total: ${(totalOriginalBytes / 1024 / 1024).toFixed(2)} MB ‚Üí ${(totalNewBytes / 1024 / 1024).toFixed(2)} MB | saved ${savedPercent}%`,
            );
        },
    };
}

export default convertWebp; // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ convertWebp –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

// ==============================================
// –û–±–∑–æ—Ä –º–µ—Ç–æ–¥–æ–≤
// ==============================================
//
// convertWebp(options)
//   –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–ª–∞–≥–∏–Ω–∞. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã,
//   –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ö—É–∫–∏ Vite.
//
// isExcluded(filePath)
//   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –∏—Å–∫–ª—é—á–∏—Ç—å —Ñ–∞–π–ª –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –ø–∞–ø–∫–µ.
//
// convertFile(filePath)
//   –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –æ–¥–∏–Ω JPG/PNG —Ñ–∞–π–ª –≤ WebP, –∑–∞–º–µ–Ω—è–µ—Ç
//   –æ—Ä–∏–≥–∏–Ω–∞–ª –∏ –≤—ã–≤–æ–¥–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∫–æ–Ω—Å–æ–ª—å.
//
// walkDir(dir)
//   –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ö–æ–¥–∏—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ñ–∞–π–ª—ã.
//
// updateHtmlUrls(dir)
//   –û–±–Ω–æ–≤–ª—è–µ—Ç HTML —Ñ–∞–π–ª—ã, –∑–∞–º–µ–Ω—è—è JPG/PNG —Å—Å—ã–ª–∫–∏ –Ω–∞ WebP.
//
// closeBundle()
//   –•—É–∫ Vite, –≤—ã–∑—ã–≤–∞–µ–º—ã–π –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏; –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è,
//   –æ–±–Ω–æ–≤–ª—è–µ—Ç HTML –∏ –≤—ã–≤–æ–¥–∏—Ç –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —ç–∫–æ–Ω–æ–º–∏–∏.
//
